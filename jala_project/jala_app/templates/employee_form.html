{% extends 'base.html' %}
{% load static %}

{% block title %}Employee Form{% endblock %}

{% block content %}
<div class="container mt-4">
  <h4>Employee <small class="text-muted">{{ form_mode|title }}</small></h4>
  <hr>

  <form method="post">
    {% csrf_token %}

    <div class="row mb-3">
      <div class="col-md-4">{{ form.first_name.label_tag }} {{ form.first_name }}</div>
      <div class="col-md-4">{{ form.last_name.label_tag }} {{ form.last_name }}</div>
      <div class="col-md-4">{{ form.email.label_tag }} {{ form.email }}</div>
    </div>

    <div class="row mb-3">
      <div class="col-md-4">{{ form.mobile_number.label_tag }} {{ form.mobile_number }}</div>
      <div class="col-md-4">{{ form.dob.label_tag }} {{ form.dob }}</div>
      <div class="col-md-4">
        <label class="form-label">Gender</label>
        {% for radio in form.gender %}
        <div class="form-check">
          {{ radio.tag }} <label class="form-check-label">{{ radio.choice_label }}</label>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-12">{{ form.address.label_tag }} {{ form.address }}</div>
    </div>

    <div class="row mb-3">
      <div class="col-md-4">
        {{ form.country.label_tag }} {{ form.country }}
        {% if form.country.errors %}
        <div class="text-danger">
          {% for error in form.country.errors %}{{ error }}{% endfor %}
        </div>
        {% endif %}
      </div>
      <div class="col-md-4">
        <label class="form-label" for="cityDropdown">City</label>
        <select id="cityDropdown" class="form-select" name="city_dropdown_val">
          <option value="">Select City</option>
          <optgroup label="India" class="d-none india">
            <option value="Chennai">Chennai</option>
            <option value="Mumbai">Mumbai</option>
            <option value="Delhi">Delhi</option>
            <option value="Bangalore">Bangalore</option>
          </optgroup>
          <optgroup label="USA" class="d-none usa">
            <option value="New York">New York</option>
            <option value="Chicago">Chicago</option>
            <option value="Los Angeles">Los Angeles</option>
          </optgroup>
          <optgroup label="UK" class="d-none uk">
            <option value="London">London</option>
            <option value="Manchester">Manchester</option>
            <option value="Liverpool">Liverpool</option>
          </optgroup>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label" for="otherCityInput">Other City</label>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="otherCityCheck">
          <label class="form-check-label" for="otherCityCheck">Other City</label>
        </div>
        <input type="text" id="otherCityInput" name="city" class="form-control mt-2" placeholder="Enter other city" style="display: none;">
        {% if form.city.errors %}
        <div class="text-danger">
          {% for error in form.city.errors %}{{ error }}{% endfor %}
        </div>
        {% endif %}
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-12">
        <label class="form-label">Skills</label>
        <div>
          {% for checkbox in form.skills %}
          <div class="form-check form-check-inline">
            {{ checkbox.tag }} <label class="form-check-label">{{ checkbox.choice_label }}</label>
          </div>
          {% endfor %}
        </div>
        {% if form.skills.errors %}
        <div class="text-danger">
          {% for error in form.skills.errors %}{{ error }}{% endfor %}
        </div>
        {% endif %}
      </div>
    </div>

    <button type="submit" class="btn btn-success">Save</button>
    <a href="{% url 'dashboard' %}" class="btn btn-danger">Cancel</a>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const countrySelect = document.getElementById("id_country");
  const cityDropdown = document.getElementById("cityDropdown");
  const otherCityCheck = document.getElementById("otherCityCheck");
  const otherCityInput = document.getElementById("otherCityInput");
  const initialCityValue = "{{ form.initial.city|escapejs }}";

  const predefinedCities = {
    'India': ['Chennai', 'Mumbai', 'Delhi', 'Bangalore'],
    'USA': ['New York', 'Chicago', 'Los Angeles'],
    'UK': ['London', 'Manchester', 'Liverpool']
  };

  function isPredefinedCity(city, country) {
    return city && country && predefinedCities[country]?.includes(city);
  }

  function updateCityOptions() {
    document.querySelectorAll("optgroup").forEach(group => group.classList.add("d-none"));
    const country = countrySelect.value;
    if (country === "India") document.querySelector(".india").classList.remove("d-none");
    else if (country === "USA") document.querySelector(".usa").classList.remove("d-none");
    else if (country === "UK") document.querySelector(".uk").classList.remove("d-none");
    cityDropdown.value = "";

    if (["edit", "create"].includes("{{ form_mode }}") && initialCityValue && country) {
      if (isPredefinedCity(initialCityValue, country)) {
        cityDropdown.value = initialCityValue;
        otherCityCheck.checked = false;
      } else {
        otherCityCheck.checked = true;
        otherCityInput.value = initialCityValue;
      }
    }

    toggleOtherCity();
  }

  function toggleOtherCity() {
    if (otherCityCheck.checked) {
      cityDropdown.disabled = true;
      cityDropdown.name = "_city_dropdown_placeholder";
      cityDropdown.value = "";
      otherCityInput.style.display = "block";
      otherCityInput.disabled = false;
      otherCityInput.name = "city";
      otherCityInput.focus();
    } else {
      cityDropdown.disabled = false;
      cityDropdown.name = "city";
      otherCityInput.style.display = "none";
      otherCityInput.disabled = true;
      otherCityInput.name = "_other_city_placeholder";
      otherCityInput.value = "";
    }
  }

  countrySelect.addEventListener("change", updateCityOptions);
  cityDropdown.addEventListener("change", () => {
    if (cityDropdown.value !== "") {
      otherCityCheck.checked = false;
      toggleOtherCity();
    }
  });
  otherCityCheck.addEventListener("change", toggleOtherCity);

  document.addEventListener("DOMContentLoaded", updateCityOptions);
</script>
{% endblock %}
